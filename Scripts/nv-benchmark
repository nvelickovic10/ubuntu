#!/bin/bash
# This script will test download and upload speed

SCALEFACTOR="scale=2;" # 2 decimal points
DIVISIONFACTOR=1048576 # 1 MB/s = 1048576 KB/s
FILESIZE=150000000 # 150 MB

echo "DECIMAL POINTS: $SCALEFACTOR"
echo "DIVISION FACTOR: $DIVISIONFACTOR"
echo "FILESIZE: $(echo "$SCALEFACTOR $FILESIZE/$DIVISIONFACTOR" | bc -q) MB"

nettest () {
  echo "==== Starting download speed test ===="
  DSTATS=$(curl -o /tmp/speedtestnv -w '%{speed_download} %{local_ip}  %{local_port} %{remote_ip}  %{remote_port}' http://speedtest.sbb.rs:8080/download?size=$FILESIZE)
  echo "==== Finished download speed test ===="
  echo

  echo "==== Starting upload speed test ===="
  USTATS=$(curl -F data=@/tmp/speedtestnv -w '%{speed_upload}' http://speedtest.sbb.rs:8080/upload)
  wait
  echo "==== Finished upload speed test ===="
  echo
  
  rm -f /tmp/speedtestnv

  echo "$SCALEFACTOR $(echo $DSTATS | awk '{print $1}')/$DIVISIONFACTOR" | bc -q | sed "s/$/ MB\/s/;s/^/\n\tDownload speed\: /"
  echo "$SCALEFACTOR $USTATS/$DIVISIONFACTOR" | bc -q | sed "s/$/ MB\/s/;s/^/\tUpload speed\: /"
  echo "$DSTATS" | awk '{print $2":"$3}' | sed  "s/^/\tLaddress\: /"
  echo "$DSTATS" | awk '{print $4":"$5}' | sed  "s/^/\tRaddress\: /"
}

cputest () {
	cpuName=$(cat /proc/cpuinfo | grep "model name" | cut -d ":" -f2 | tr -s " " | head -n 1);
	cpuCount=$(cat /proc/cpuinfo | grep "model name" | cut -d ":" -f2 | wc -l);
	echo "CPU: $cpuCount x$cpuName";
	echo -n "Time taken to generate PI to 5000 decimal places with a single thread: ";
	(time echo "scale=5000; 4*a(1)" | bc -lq) 2>&1 | grep real |  cut -f2
}

disktest () {
	echo "Writing 4GB file to disk"
	mkdir /tmp/nv-benchmark
	dd if=/dev/zero of=/tmp/nv-benchmark/disktestnv bs=4096 count=1024k conv=fdatasync 2>&1 | tail -n 1 | cut -d " " -f3-;
	echo "READING 4GB from file"
	dd if=/tmp/nv-benchmark/disktestnv of=/dev/null bs=4096 conv=fdatasync 2>&1 | tail -n 1 | cut -d " " -f3-;
	rm -rf /tmp/nv-benchmark;
}

## start net test
echo "---------------CPU test--------------------";
nettest;

## start CPU test
echo "---------------CPU test--------------------";
cputest;

## start disk test
echo "----------------IO test-------------------";
disktest;
