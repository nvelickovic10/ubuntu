#!/bin/bash
# Script used for starting/stopping hyperthreading

SCRIPT_DESC="Script used for starting/stopping hyperthreading"
commons_dir="/usr/local/bin/common"

# Include common functions
. ${commons_dir}/common.sh

# Include root functions
. ${commons_dir}/sudoUtil.sh

function printHelpAndExit {
    echo "USAGE"
    echo "  ${SCRIPT_NAME} [--start | --stop | --help]"
    echo
    echo "DESCRIPTION"
    echo "  ${SCRIPT_DESC}"
    echo
    echo "OPTIONS"
    echo "  --start,  --s         : Select start action (default)"
    echo "  --stop, --x           : Select stop action"
    echo
    echo "  --help,   --h         : Show this help"
    exit 1
}

function startHyperthreading {
    local LCOMMAND="echo 1 > /sys/devices/system/cpu/cpu2/online"
    logInfo "Starting processor: 2"
    runAsSudo "${LCOMMAND}"
    
    local LCOMMAND="echo 1 > /sys/devices/system/cpu/cpu3/online"
    logInfo "Starting processor: 3"
    runAsSudo "${LCOMMAND}"
}

function stopHyperthreading {
    local LCOMMAND="echo 0 > /sys/devices/system/cpu/cpu2/online"
    logInfo "Stopping processor: 2"
    runAsSudo "${LCOMMAND}"
    
    local LCOMMAND="echo 0 > /sys/devices/system/cpu/cpu3/online"
    logInfo "Stopping processor: 3"
    runAsSudo "${LCOMMAND}"
}

ACTION="startHyperthreading"
# Parsing command line arguments
for arg; do
    case "${arg}" in
        --start|--s)
            ACTION="startHyperthreading"
        ;;
        --stop|--x)
            ACTION="stopHyperthreading"
        ;;
        --help)
            printHelpAndExit
        ;;
    esac
done

COMMAND="${ACTION}"

logInfo "ACTION: ${ACTION}"
logInfo "COMMAND: ${COMMAND}"
eval ${COMMAND}

# END
