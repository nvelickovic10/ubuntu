#!/bin/bash
# Script used for stopping tomcat on port

SCRIPT_DESC="Script used for stopping tomcat on port"
commons_dir="/usr/local/bin/common"

# Include common functions
. ${commons_dir}/common.sh

# Include root functions
. ${commons_dir}/sudoUtil.sh

SERVICES_PORT=8080
CONNECTOR_PORT=8480

function printHelpAndExit {
    echo "USAGE"
    echo "  ${SCRIPT_NAME} [--skip] [--services | --connector | -p <port> | --help]"
    echo
    echo "DESCRIPTION"
    echo "  ${SCRIPT_DESC}"
    echo
    echo "OPTIONS"
    echo "  --skip                   : Skip kill"
    echo "  --services,  --s         : Kill iac-services on port 8080"
    echo "  --connector, --c         : Kill iac-mfx-connector on port 8480"
    echo "  --port,      --p <port>  : Kill tomcat on port <port>"
    echo
    echo "  --help,   --h         : Show this help"
    exit 1
}

function killTomcatServer {
    logInfo "lsof -ti :${1}"
    PID=$(lsof -ti :${1})
    if [ -z "$PID" ]
    then
        logInfo "NO TOMCAT INSTANCE FOUND ON PORT ${PORT}"
    else
        logInfo "TOMCAT INSTANCE FOUND ON PORT ${PORT} WITH PID ${PID}"
        if [ -z "$SKIP" ]
        then
            runAsSudo "kill -9 ${PID}"
        else
            logInfo "SKIP KILL"
        fi
    fi
}

# Parsing command line arguments
for arg; do
    case "${arg}" in
        --services|--s)
            PORT=${SERVICES_PORT}
        ;;
        --connector|--c)
            PORT=${CONNECTOR_PORT}
        ;;
        --port|--p)
            PORT=${2}
        ;;
        --skip)
            SKIP=1
        ;;
        --help)
            printHelpAndExit
        ;;
    esac
done

if [ -z "$PORT" ]
then
    printHelpAndExit
else
    logInfo "PORT: ${PORT}, SKIP: ${SKIP}"
    killTomcatServer ${PORT}
fi

# END