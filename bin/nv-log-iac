#!/bin/bash
# This script is used to check connection and to connect to IAC servers

SCRIPT_DESC="This script is used to check connection ant to connect to IAC servers"
commons_dir="/usr/local/bin/common"

# Include common functions
. ${commons_dir}/common.sh

function downloadLog {
    scp tmweb@${LEVEL}$1.iac.${CLUSTER}.websys.tmcs:/app/local/log/iac-services.log /tmp/$CLUSTER-services$1.log
}

function grepStats {
    logInfo "RESULTS FOR $1:"
    grep 'Duration of entry scan' $1 | sed 's/.* = \([0-9][0-9]*\)/\1/' | awk '{if($1==$1+0 && $1>1)print $1}' | awk '{ total += $1; count++; {if($1>200)G200++}; {if($1>300)G300++}; {if($1>500)G500++} } END { print "average scan time: " total/count "\ntotal scans: " count "\n>200: " G200 "\n>300: " G300 "\n>500: " G500}'
}

LEVEL=app
CLUSTER=eunstg1

LOG1=/tmp/$CLUSTER-services1.log
LOG2=/tmp/$CLUSTER-services2.log
LOGCOMBINED=/tmp/$CLUSTER-services-combined.log

downloadLog 1
downloadLog 2

cat $LOG1 $LOG2 | sort > $LOGCOMBINED

grepStats $LOG1 
echo
grepStats $LOG2 
echo
grepStats $LOGCOMBINED


# cat $CLUSTER-services.log $CLUSTER-services2.log | sort > $CLUSTER-services-combined.log
# rm $CLUSTER-services.log $CLUSTER-services2.log
# grep 'Duration of entry scan' $CLUSTER-services-combined.log | sed 's/.* = \([0-9][0-9]*\)/\1/' | awk '{if($1==$1+0 && $1>1)print $1}' | awk '{ total += $1; count++; {if($1>200)G200++}; {if($1>300)G300++}; {if($1>500)G500++} } END { print "\n\nRESULTS:\naverage scan time: " total/count "\ntotal scans: " count "\n>200: " G200 "\n>300: " G300 "\n>500: " G500}'
